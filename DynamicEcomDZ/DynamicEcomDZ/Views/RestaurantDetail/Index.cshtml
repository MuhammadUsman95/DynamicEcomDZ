@model DynamicEcomDZ.Models.RestaurantDetailViewModel

@{
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>@Model.RestaurantName</title>

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <style>
        body {
            background: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* ===== SLIDER ===== */
        #detailSlider {
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 12px 40px rgba(0,0,0,0.35);
            max-width: 1290px;
            margin: 20px auto 40px;
            position: relative;
        }

            #detailSlider .carousel-inner img {
                width: 100%;
                height: 400px;
                object-fit: cover;
                filter: brightness(60%);
                transition: filter 0.3s ease;
            }

            #detailSlider:hover .carousel-inner img {
                filter: brightness(75%);
            }

            #detailSlider .carousel-caption {
                position: absolute;
                top: 50%;
                left: 6%;
                transform: translateY(-50%);
                z-index: 10;
                color: white;
                text-align: left;
                max-width: 55%;
                text-shadow: 3px 3px 8px rgba(0,0,0,0.8);
                background: rgba(0, 0, 0, 0.25);
                padding: 20px 25px;
                border-radius: 12px;
            }

                #detailSlider .carousel-caption h2 {
                    font-size: 40px;
                    font-weight: 900;
                    margin-bottom: 14px;
                }

                #detailSlider .carousel-caption p {
                    font-size: 18px;
                    line-height: 1.6;
                }

            #detailSlider .carousel-indicators {
                bottom: 20px;
            }

                #detailSlider .carousel-indicators button {
                    width: 14px;
                    height: 14px;
                    border-radius: 50%;
                    background-color: #fff;
                    opacity: 0.8;
                    transition: opacity 0.3s ease;
                }

                #detailSlider .carousel-indicators .active {
                    opacity: 1;
                }

            #detailSlider .carousel-control-prev-icon,
            #detailSlider .carousel-control-next-icon {
                filter: invert(1);
                background-size: 100% 100%;
            }

        /* Mobile responsive slider */
        @@media (max-width: 768px) {
            #detailSlider {
                margin: 15px auto 30px;
                border-radius: 12px;
            }

                #detailSlider .carousel-inner img {
                    height: 250px;
                }

                #detailSlider .carousel-caption {
                    left: 5%;
                    max-width: 90%;
                    padding: 15px 20px;
                }

                    #detailSlider .carousel-caption h2 {
                        font-size: 24px;
                        margin-bottom: 10px;
                    }

                    #detailSlider .carousel-caption p {
                        font-size: 14px;
                    }

                #detailSlider .carousel-indicators {
                    bottom: 10px;
                }

                    #detailSlider .carousel-indicators button {
                        width: 10px;
                        height: 10px;
                    }
        }

        @@media (max-width: 576px) {
            #detailSlider .carousel-inner img {
                height: 200px;
            }

            #detailSlider .carousel-caption {
                top: auto;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                text-align: center;
                padding: 10px 15px;
                width: 90%;
                max-width: none;
                box-sizing: border-box;
            }

                #detailSlider .carousel-caption h2 {
                    font-size: 18px;
                    margin-bottom: 8px;
                }

                #detailSlider .carousel-caption p {
                    font-size: 12px;
                    line-height: 1.4;
                }
        }
    </style>
    <style>
        .main-header {
            position: sticky;
            top: 0;
            background: #ffffff;
            z-index: 1000;
            padding: 14px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

            .main-header h3 {
                font-weight: 800;
                color: #0d6efd;
                font-size: 1.5rem;
            }

        .cart-icon {
            position: relative;
            font-size: 26px;
            cursor: pointer;
            color: #0d6efd;
        }

        .cart-count {
            position: absolute;
            top: -6px;
            right: -10px;
            background: #dc3545;
            color: #fff;
            font-size: 12px;
            font-weight: 700;
            padding: 3px 7px;
            border-radius: 50%;
        }

        .cart-drawer {
            position: fixed;
            top: 0;
            right: -400px;
            width: 360px;
            height: 100%;
            background: #ffffff;
            box-shadow: -8px 0 24px rgba(0,0,0,0.2);
            z-index: 1300;
            padding: 20px;
            transition: right 0.35s ease;
            display: flex;
            flex-direction: column;
        }

            .cart-drawer.open {
                right: 0;
            }

        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #0d6efd;
            padding-bottom: 10px;
            margin-bottom: 16px;
        }

            .cart-header h4 {
                font-weight: 800;
                color: #0d6efd;
            }

            .cart-header button {
                border: none;
                background: none;
                font-size: 22px;
                cursor: pointer;
            }

        .cart-total {
            margin-top: auto;
            font-weight: 900;
            font-size: 1.3rem;
            border-top: 2px solid #0d6efd;
            padding-top: 12px;
            text-align: right;
        }

        .main-footer {
            background: #0d6efd;
            color: #ffffff;
            padding: 18px 0;
            font-weight: 600;
        }

        .cart-drawer {
            position: fixed;
            top: 0;
            right: -380px;
            width: 360px;
            height: 100vh;
            background: #fff;
            z-index: 1300;
            display: flex;
            flex-direction: column;
            transition: right .35s ease;
        }

            .cart-drawer.open {
                right: 0;
            }

        /* HEADER FIXED */
        .cart-header {
            flex-shrink: 0;
        }

        /* ITEMS SCROLL AREA */
        .cart-items-scroll {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 6px;
            max-height: calc(70px * 7); /* EXACTLY 7 ITEMS */
        }

        /* TOTAL FIXED */
        .cart-total {
            flex-shrink: 0;
            border-top: 2px solid #0d6efd;
            padding-top: 12px;
        }

        .cart-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            min-height: 70px;
        }

        .cart-item-img {
            width: 48px;
            height: 48px;
            object-fit: cover;
            border-radius: 8px;
        }

        .cart-items-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .cart-items-scroll::-webkit-scrollbar-thumb {
            background: #0d6efd;
            border-radius: 10px;
        }

        /* Mobile responsive cart drawer */
        @@media (max-width: 576px) {
            .cart-drawer {
                width: 100%;
                right: -100%;
            }

            .main-header h3 {
                font-size: 1.2rem;
            }

            .cart-icon {
                font-size: 22px;
            }
        }


        .cart-total {
            margin-top: 12px;
            padding: 14px;
            border-top: 1px solid #e5e5e5;
            font-family: 'Segoe UI', Roboto, Arial, sans-serif;
            font-size: 14px;
        }

            .cart-total .total-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
                color: #333;
            }

                .cart-total .total-row span {
                    font-weight: 500;
                }

                .cart-total .total-row.discount {
                    color: #dc3545;
                }

                .cart-total .total-row.net {
                    margin-top: 10px;
                    padding-top: 10px;
                    border-top: 1px dashed #ccc;
                    font-size: 16px;
                }

                    .cart-total .total-row.net strong:last-child {
                        color: #198754; /* Bootstrap success */
                    }

        .cart-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            font-family: 'Segoe UI', Roboto, Arial, sans-serif;
        }

        .cart-item-info {
            flex: 1;
            margin-left: 10px;
        }

        .cart-item-total {
            font-weight: 600;
            min-width: 60px;
            text-align: right;
        }

    </style>

    <style>
        /* ===== SEARCH ===== */
        .product-search-wrapper {
            display: flex;
            justify-content: center;
            margin: 30px 0 50px;
        }

        .product-search-input {
            width: 100%;
            max-width: 420px;
            padding: 4px 12px;
            border-radius: 8px;
            border: 2px solid #dedede;
            font-size: 1.05rem;
            transition: all 0.3s ease;
        }

            .product-search-input:focus {
                outline: none;
                box-shadow: 0 0 12px rgba(13,110,253,.4);
            }

        /* ===== CATEGORY ===== */
        .product-category-title {
            text-align: center;
            font-weight: 800;
            font-size: 1.4rem;
            color: #0d6efd;
            margin: 40px 0 25px;
            letter-spacing: 1px;
        }

        /* ===== PRODUCT CARD ===== */
        .product-item {
            background: #ffffff;
            border-radius: 18px;
            overflow: hidden;
            height: 100%;
            box-shadow: 0 10px 22px rgba(0,0,0,.12);
            transition: transform .35s ease, box-shadow .35s ease;
            display: flex;
            flex-direction: column;
        }

            .product-item:hover {
                transform: translateY(-10px);
                box-shadow: 0 28px 40px rgba(0,0,0,.22);
            }

        /* IMAGE */
        .product-img {
            height: 150px;
            overflow: hidden;
        }

            .product-img img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                transition: transform .4s ease;
            }

        .product-item:hover img {
            transform: scale(1.08);
        }

        /* INFO */
        .product-info {
            padding: 14px 14px 16px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex-grow: 1;
        }

        .product-name {
            font-size: 1rem;
            font-weight: 700;
            margin: 0;
        }

        .product-code {
            font-size: .8rem;
            color: #6c757d;
        }

        /* PRICE */
        .product-price {
            margin-top: auto;
        }

        .current-price {
            font-weight: 800;
            font-size: 1.05rem;
            color: #198754;
        }

        .old-price {
            margin-left: 8px;
            font-size: .9rem;
            color: #dc3545;
            text-decoration: line-through;
        }

        /* QUANTITY */
        .qty-box {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 12px;
            gap: 12px;
        }

        .qty-btn {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #0d6efd, #084298);
            color: #fff;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform .2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

            .qty-btn:hover {
                transform: scale(1.1);
            }

            .qty-btn:active {
                transform: scale(0.95);
            }

        .qty-value {
            font-size: 1.1rem;
            font-weight: 700;
            min-width: 26px;
            text-align: center;
        }

        /* Mobile responsive product cards */
        @@media (max-width: 768px) {
            .product-img {
                height: 130px;
            }

            .product-name {
                font-size: .95rem;
            }

            .qty-btn {
                width: 32px;
                height: 32px;
                font-size: 1.1rem;
            }

            .qty-value {
                font-size: 1rem;
            }
        }

        @@media (max-width: 576px) {
            .product-img {
                height: 120px;
            }

            .product-name {
                font-size: .9rem;
            }

            .product-code {
                font-size: .75rem;
            }

            .current-price {
                font-size: 1rem;
            }

            .old-price {
                font-size: .85rem;
            }

            .qty-btn {
                width: 30px;
                height: 30px;
                font-size: 1rem;
            }

            .qty-value {
                font-size: .95rem;
            }

            .qty-box {
                gap: 10px;
            }
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 8px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            font-weight: 600;
            font-size: .95rem;
        }

        .cart-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.45);
            z-index: 900;
            opacity: 0;
            visibility: hidden;
            transition: .3s ease;
        }

            .cart-backdrop.show {
                opacity: 1;
                visibility: visible;
            }

        .product-img {
            background: #f1f1f1;
        }

        .cart-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 5px;
            border-bottom: 1px solid #eee;
        }

        .cart-item-img {
            width: 48px;
            height: 48px;
            object-fit: cover;
            border-radius: 6px;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-total {
            font-weight: 600;
        }

        /* Mobile responsive header */
        @@media (max-width: 768px) {
            .main-header .container {
                padding: 0 15px;
            }

            .product-search-input {
                max-width: 200px;
                font-size: 0.9rem;
            }
        }

        @@media (max-width: 576px) {
            .main-header {
                padding: 10px 0;
            }

                .main-header .container {
                    flex-wrap: wrap;
                    justify-content: space-between;
                }

                .main-header h3 {
                    width: 100%;
                    text-align: center;
                    margin-bottom: 10px;
                    font-size: 1.3rem;
                }

            .product-search-input {
                max-width: 100%;
                margin-bottom: 5px;
            }
        }
    </style>

    <style>
        /* Initial state (hidden) */
        #orderSuccessModal .modal-dialog {
            transform: scale(0.6);
            transition: transform 0.3s ease-out;
        }

        /* When modal is shown */
        #orderSuccessModal.show .modal-dialog {
            transform: scale(1);
        }

        .success-gif {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            object-fit: cover;
        }

        .modal-content {
            border-radius: 12px;
        }

        .input-group-text {
            background-color: #f8f9fa;
        }

        .modal-header {
            background: #f1f5f9;
        }

        /* Add this to your <style> section */
        .loading-swal-container {
            z-index: 99999 !important;
        }

        .loading-swal-popup {
            z-index: 99999 !important;
        }

        /* Ensure modal backdrop is below SweetAlert */
        .modal-backdrop {
            z-index: 1040 !important;
        }

        /* Ensure modal is below SweetAlert */
        .modal {
            z-index: 1050 !important;
        }

        .flying-img {
            position: fixed;
            z-index: 9999;
            pointer-events: none;
            transition: all 0.8s ease-in-out;
            border-radius: 8px;
        }

        /* Mobile responsive modals */
        @@media (max-width: 576px) {
            .modal-dialog {
                margin: 10px;
            }

            .modal-body {
                padding: 15px;
            }

            .success-gif {
                width: 100px;
                height: 100px;
            }
        }

        .product-img {
            position: relative;
        }

        .discount-badge {
            position: absolute;
            top: 7px;
            right: 6px;
            background: #dc3545;
            color: #fff;
            font-size: 15px;
            font-weight: 600;
            padding: 2px 5px;
            border-radius: 6px;
            z-index: 2;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>

<!-- CLOSED MODAL -->
<div class="modal fade" id="closedModal">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Restaurant Closed</h5>
            </div>
            <div class="modal-body">
                This restaurant is currently closed.
            </div>
            <div class="modal-footer justify-content-center">
                <button class="btn btn-secondary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="checkoutModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-person-lines-fill me-2"></i>
                    Customer Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-6">
                        <label class="form-label">Contact # *</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-telephone"></i></span>
                            <input type="text" id="ContactNo" class="form-control next-input" maxlength="15">
                        </div>
                    </div>

                    <div class="col-6">
                        <label class="form-label">Name *</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-person"></i></span>
                            <input type="text" id="CustomerName" class="form-control next-input">
                        </div>
                    </div>

                    <div class="col-6">
                        <label class="form-label">Street *</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-signpost"></i></span>
                            <input type="text" id="Street" class="form-control next-input">
                        </div>
                    </div>

                    <div class="col-6">
                        <label class="form-label">Floor *</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-layers"></i></span>
                            <input type="text" id="Floor" class="form-control next-input">
                        </div>
                    </div>

                    <!-- 🔹 Full Width -->
                    <div class="col-12">
                        <label class="form-label">Address *</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-house"></i></span>
                            <input type="text" id="CustomerAddress" class="form-control next-input">
                        </div>
                    </div>

                    <!-- 🔹 Description Full Width -->
                    <div class="col-12">
                        <label class="form-label">Description</label>
                        <textarea id="Description" class="form-control next-input" rows="2"></textarea>
                    </div>

                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i> Cancel
                </button>
                <button class="btn btn-success" onclick="placeOrder()">
                    <i class="bi bi-check-circle me-1"></i> Place Order
                </button>
            </div>

        </div>
    </div>
</div>


<body>

    <div class="modal fade" id="orderSuccessModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center p-4">
                <div class="modal-body">
                    <img id="orderStatusGif"
                         src="/Images/GIF/OrderSuccess.gif"
                         class="success-gif mb-3"
                         alt="Order Status" />
                    <div id="orderSuccessMessage" class="mt-2"></div>
                </div>

                <div class="modal-footer justify-content-center" style="padding: 0;border: none;">
                    <button type="button" class="btn btn-success" data-bs-dismiss="modal">
                        OK, Thank You
                    </button>
                </div>
            </div>
        </div>
    </div>



    <!-- ================= HEADER ================= -->
    <header class="main-header shadow-sm">
        <div class="container d-flex justify-content-between align-items-center">
            <div class="logo">
                <h3 class="mb-0">@Model.RestaurantName</h3>
            </div>

            <!-- ================= PRODUCT SEARCH ================= -->
            <div>
                <input type="text"
                       id="productSearchBox"
                       class="product-search-input"
                       placeholder="Search products..."
                       onkeyup="filterProducts()" />
            </div>
            <!-- ================= PRODUCT SEARCH ================= -->

            <div class="cart-icon" id="cartIcon" onclick="toggleCart()">
                <span class="cart-count" id="cartCount">0</span>
                <i class="bi bi-cart3"></i>
            </div>

        </div>
    </header>


    <!-- ================= SLIDER ================= -->
    <div id="detailSlider" class="carousel slide" data-bs-ride="carousel">

        <div class="carousel-indicators">
            @for (int i = 0; i < Model.Sliders.Count; i++)
            {
                <button type="button" data-bs-target="#detailSlider" data-bs-slide-to="@i" class="@(i == 0 ? "active" : "")" aria-current="@(i == 0 ? "true" : "false")" aria-label="Slide @(i + 1)"></button>
            }
        </div>

        <div class="carousel-inner">
            @for (int i = 0; i < Model.Sliders.Count; i++)
            {
                var s = Model.Sliders[i];
                <div class="carousel-item @(i == 0 ? "active" : "")" data-bs-interval="@(s.SliderMovingTimer * 1000)">
                    <img src="@("/images/Slider/" + s.SilderName)" alt="Slider Image @i" />
                    <div class="carousel-caption">
                        <h2>@s.HeadingSlider</h2>
                        <p>@s.DescriptionSlider</p>
                    </div>
                </div>
            }
        </div>

        <button class="carousel-control-prev" type="button" data-bs-target="#detailSlider" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
        </button>

        <button class="carousel-control-next" type="button" data-bs-target="#detailSlider" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
        </button>
    </div>

    <!-- ================= PRODUCTS ================= -->
    <div class="container product-section" id="productsContainer">
        @foreach (var category in Model.Products)
        {
            <h3 class="product-category-title">
                <spn style="
                            background-color: #414040;
                            color: white;
                            padding: 7px;
                            border-radius: 7px;
                            ">@category.Key</spn>
            </h3>

            <div class="row g-4">
                @foreach (var product in category.Value)
                {
                    <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 col-6 product-card"
                         data-product-name="@product.ProductName.ToLower()">

                        <div class="product-item">
                            <div class="product-img">
                                @if (product.DiscountAmount > 0)
                                {
                                    <span class="discount-badge">
                                        -@product.DiscountAmount
                                    </span>
                                }

                                <img src="@("/images/Product/" + product.ProductImage)"
                                     alt="@product.ProductName"
                                     id="img-@product.ProductCode" />
                            </div>

                            <div class="product-info">
                                <h6 class="product-name">@product.ProductName</h6>
                                <span class="product-code">@product.ProductCode</span>

                                <div class="product-price">
                                    <span class="current-price">@(product.Prices - product.DiscountAmount)</span>

                                    @if (product.DiscountAmount > 0)
                                    {
                                        <span class="old-price">
                                            @(product.Prices)
                                        </span>
                                    }
                                </div>

                                <div class="qty-box">
                                    <button type="button" class="qty-btn" onclick="changeQuantity('@product.ProductCode', '@product.ProductName', -1)">
                                        −
                                    </button>
                                    <span class="qty-value" id="qty-@product.ProductCode">0</span>
                                    <button type="button" class="qty-btn" onclick="changeQuantity('@product.ProductCode', '@product.ProductName', 1)">
                                        +
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                }
            </div>
        }
    </div>


    <!-- ================= CART DRAWER ================= -->
    <div id="cartDrawer" class="cart-drawer">
        <div class="cart-header">
            <h4>Your Cart</h4>
            <button onclick="toggleCart()">✕</button>
        </div>

        <div id="cartItemsContainer" class="cart-items-scroll">
            <p class="empty-msg">Your cart is empty.</p>
        </div>

        <div id="cartTotal" class="cart-total" style="display:none;"></div>

        <!-- Checkout Button -->
        <div class="checkout-wrapper mt-3 text-center">
            <button id="checkoutBtn" class="btn btn-success w-100" onclick="openCheckoutModal()">
                Checkout
            </button>
        </div>

    </div>

    <!-- Cart Backdrop for Mobile -->
    <div id="cartBackdrop" class="cart-backdrop" onclick="toggleCart()"></div>




    <footer class="main-footer mt-5">
        <div class="container text-center">
            <p class="mb-0">
                © @DateTime.Now.Year @Model.RestaurantName · Powered by Usman
            </p>
        </div>
    </footer>







    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const productMaster = @Html.Raw(
                        System.Text.Json.JsonSerializer.Serialize(
                                Model.Products.SelectMany(x => x.Value)
                        )
                );


        function getProductByCode(productCode) {
            return productMaster.find(p => p.ProductCode === productCode);
        }


        // Cart data structure { productName: { qty, price } }
        let cart = {};

        function changeQuantity(productCode, productName, delta) {

            const qtySpan = document.getElementById('qty-' + productCode);
            let currentQty = parseInt(qtySpan.textContent) || 0;
            let newQty = currentQty + delta;

            if (newQty < 0) newQty = 0;
            qtySpan.textContent = newQty;

            const product = getProductByCode(productCode);
            if (!product) return;

            if (delta > 0) {
                flyToCart(productCode);
            }

            if (newQty === 0) {
                delete cart[productCode];
            } else {
                cart[productCode] = {
                    ProductCode: productCode,
                    ProductName: product.ProductName,
                    Quantity: newQty,
                    Rate: product.Prices,
                    DiscountAmount: product.DiscountAmount,
                    image: product.ProductImage
                };
            }

            renderCart();
        }

        function flyToCart(productCode) {

            const img = document.getElementById('img-' + productCode);
            const cartIcon = document.getElementById('cartIcon');

            if (!img || !cartIcon) return;

            const imgRect = img.getBoundingClientRect();
            const cartRect = cartIcon.getBoundingClientRect();

            const flyingImg = img.cloneNode(true);
            flyingImg.classList.add("flying-img");

            document.body.appendChild(flyingImg);

            flyingImg.style.left = imgRect.left + "px";
            flyingImg.style.top = imgRect.top + "px";
            flyingImg.style.width = imgRect.width + "px";
            flyingImg.style.height = imgRect.height + "px";

            requestAnimationFrame(() => {
                flyingImg.style.left = cartRect.left + "px";
                flyingImg.style.top = cartRect.top + "px";
                flyingImg.style.width = "20px";
                flyingImg.style.height = "20px";
                flyingImg.style.opacity = "0.2";
            });

            flyingImg.addEventListener("transitionend", () => {
                flyingImg.remove();
            });
        }



        function renderCart() {

            const container = document.getElementById("cartItemsContainer");
            const totalDiv = document.getElementById("cartTotal");

            container.innerHTML = "";

            const items = Object.values(cart);

            if (items.length === 0) {
                container.innerHTML = `<p class="empty-msg">Your cart is empty.</p>`;
                totalDiv.style.display = "none";
                return;
            }

            let totalGross = 0;
            let totalDiscount = 0;
            let totalQty = 0; // ✅ TOTAL QUANTITY

            items.forEach(item => {

                const Rate = item.Quantity * item.Rate;
                const DiscountAmount = item.Quantity * item.DiscountAmount;
                const net = Rate - DiscountAmount;

                totalGross += Rate;
                totalDiscount += DiscountAmount;
                totalQty += item.Quantity; // ✅ ADD QTY

                container.innerHTML += `
                    <div class="cart-item">
                        <img src="/images/Product/${item.image}" class="cart-item-img" />

                        <div class="cart-item-info">
                            <strong>${item.ProductName}</strong>
                            <div>${item.Quantity} × ${formatAmount(item.Rate)}</div>
                        </div>

                        <div class="cart-item-total">${formatAmount(net)}</div>
                    </div>
                `;
            });

            totalDiv.style.display = "block";
            totalDiv.innerHTML = `
                <div class="total-row">
                    <span>Total Items</span>
                    <span>${formatAmount(totalQty)}</span>
                </div>
                <div class="total-row">
                    <span>Gross</span>
                    <span>${formatAmount(totalGross)}</span>
                </div>
                <div class="total-row discount">
                    <span>Discount</span>
                    <span>- ${formatAmount(totalDiscount)}</span>
                </div>
                <div class="total-row net">
                    <strong>Payable</strong>
                    <strong>${formatAmount(totalGross - totalDiscount)}</strong>
                </div>
            `;

        }

        function formatAmount(value) {
            return Number(value).toLocaleString('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }


        function filterProducts() {

            const filter = document
                .getElementById('productSearchBox')
                .value
                .toLowerCase();

            const categoryTitles = document.querySelectorAll('.product-category-title');

            categoryTitles.forEach(title => {

                const productRow = title.nextElementSibling;
                const products = productRow.querySelectorAll('.product-card');

                let hasVisibleProduct = false;

                products.forEach(card => {
                    const name = card.getAttribute('data-product-name');

                    if (name.includes(filter)) {
                        card.style.display = '';
                        hasVisibleProduct = true;
                    } else {
                        card.style.display = 'none';
                    }
                });

                // Hide / Show category based on product visibility
                if (hasVisibleProduct) {
                    title.style.display = '';
                    productRow.style.display = '';
                } else {
                    title.style.display = 'none';
                    productRow.style.display = 'none';
                }
            });
        }


        // Custmer Detail Card modal

        function openCheckoutModal() {

            const items = Object.values(cart);

            if (items.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Cart Empty',
                    text: 'Please add items to cart before checkout.'
                });
                return;
            }

            // Close cart drawer first
            const cartDrawer = document.getElementById('cartDrawer');
            const cartBackdrop = document.getElementById('cartBackdrop');
            if (cartDrawer.classList.contains('open')) {
                cartDrawer.classList.remove('open');
                cartBackdrop.classList.remove('show');
            }

            // 🔁 Server-side restaurant validation
            fetch('/Restaurant/CheckRestaurantValidation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    RestaurantId: @Model.RestaurantId // ensure this is globally available
                })
            })
            .then(res => res.json())
            .then(data => {

                if (data.statusId === 0) {
                    // ❌ Not allowed
                    document.querySelector('#closedModal .modal-title').innerText = 'Order Not Allowed';
                    document.querySelector('#closedModal .modal-body').innerHTML = data.message;

                    new bootstrap.Modal(
                        document.getElementById('closedModal')
                    ).show();

                    return;
                }

                // ✅ Allowed → open checkout modal
                const modal = new bootstrap.Modal(
                    document.getElementById('checkoutModal')
                );
                modal.show();

            })
            .catch(() => {
                Swal.fire('Error', 'Server validation failed. Please try again.', 'error');
            });
        }

        function placeOrder() {
            const contactNo = document.getElementById("ContactNo").value.trim();
            const customerName = document.getElementById("CustomerName").value.trim();
            const customerAddress = document.getElementById("CustomerAddress").value.trim();
            const street = document.getElementById("Street").value.trim();
            const floor = document.getElementById("Floor").value.trim();
            const description = document.getElementById("Description").value.trim();

            // Validation code remains the same...
            if (!contactNo || contactNo.length < 9) {
                Swal.fire("Validation Error", "Contact No must be at least 9 digits.", "error");
                return;
            }

            if (!customerName || !customerAddress || !street || !floor) {
                Swal.fire("Validation Error", "All fields are mandatory except Description.", "error");
                return;
            }

            // Confirmation alert code remains the same...
            Swal.fire({
                title: "Confirm Order",
                text: "Are you sure you want to place this order?",
                icon: "question",
                showCancelButton: true,
                confirmButtonText: "Yes, Place Order",
                cancelButtonText: "No",
                reverseButtons: true,
                focusCancel: true
            }).then((result) => {
                if (!result.isConfirmed) return;

                // Get the modal instance before showing the loading alert
                const checkoutModal = bootstrap.Modal.getInstance(document.getElementById('checkoutModal'));

                // Hide the modal first
                checkoutModal.hide();

                // Add a small delay to ensure the modal is fully hidden
                setTimeout(() => {
                    // Show loading alert with proper focus management
                    Swal.fire({
                        title: "Please wait...",
                        html: `
                            <div style="text-align:center">
                                <img src="/Images/GIF/OrderPlaced.gif"
                                     class="success-gif mb-3"
                                     alt="Order Success" />
                                <div style="font-weight: 600;">Placing your order...</div>
                            </div>
                        `,
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        allowEnterKey: false,
                        showConfirmButton: false,
                        backdrop: 'rgba(0,0,0,0.7)',
                        customClass: {
                            popup: 'loading-swal-popup',
                            container: 'loading-swal-container'
                        },
                        didOpen: () => {
                            // Force focus to stay within the SweetAlert
                            const swalContainer = document.querySelector('.swal2-container');
                            swalContainer.setAttribute('tabindex', '-1');
                            swalContainer.focus();

                            // Add event listener to prevent tabbing out
                            swalContainer.addEventListener('keydown', (e) => {
                                if (e.key === 'Tab') {
                                    e.preventDefault();
                                    e.stopPropagation();
                                }
                            });

                            // Disable all inputs in the checkout modal
                            document.querySelectorAll('#checkoutModal input, #checkoutModal textarea').forEach(input => {
                                input.disabled = true;
                            });
                        },
                        willClose: () => {
                            // Re-enable inputs when SweetAlert closes
                            document.querySelectorAll('#checkoutModal input, #checkoutModal textarea').forEach(input => {
                                input.disabled = false;
                            });
                        }
                    });

                    const orderData = {
                        ContactNo: contactNo,
                        CustomerName: customerName,
                        CustomerAddress: customerAddress,
                        Street: street,
                        Floor: floor,
                        Description: description,
                        Items: Object.values(cart),
                        RestaurantId: @Model.RestaurantId
                    };

                    $.ajax({
                        url: "/RestaurantDetail/PlaceOrder",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(orderData),
                        success: function (res) {
                            Swal.close();
                            document.getElementById("orderSuccessMessage").innerHTML = res.message;

                            if (res.statusId === 0) {
                                document.getElementById("orderStatusGif").src = "/Images/GIF/OrderFailed.gif";
                            } else {
                                document.getElementById("orderStatusGif").src = "/Images/GIF/OrderSuccess.gif";
                                // toggleCart();
                                cart = {};
                                renderCart();
                                resetAllProductQuantities();
                                clearCheckoutModalFields();
                            }
                            // Modal show
                            new bootstrap.Modal(document.getElementById('orderSuccessModal')).show();
                        },
                        error: function () {
                            Swal.close();
                            Swal.fire("Error", "Something went wrong while placing order.", "error");
                        }
                    });
                }, 300); // Small delay to ensure modal is hidden
            });
        }

        // Custmer Detail Card modal

        function resetAllProductQuantities() {
            document.querySelectorAll('[id^="qty-"]').forEach(span => {
                span.textContent = 0;
            });
        }

        // const checkoutModal = document.getElementById("checkoutModal");
        // checkoutModal.addEventListener("hidden.bs.modal", function () {
        //     clearCheckoutModalFields();
        // });

        function clearCheckoutModalFields(isclearcontactno = true) {
            if(isclearcontactno)
            {
                document.getElementById("ContactNo").value = "";
            }
            document.getElementById("CustomerName").value = "";
            document.getElementById("CustomerAddress").value = "";
            document.getElementById("Street").value = "";
            document.getElementById("Floor").value = "";
            document.getElementById("Description").value = "";
        }
        
        document.getElementById("ContactNo").addEventListener("input", function () {
            this.value = this.value.replace(/\D/g, '');
        });

        document.getElementById("ContactNo").addEventListener("blur", function () {
            const contactNo = this.value.trim();
            if (contactNo === "") return;
            checkCustomerExist(contactNo);
        });

        function checkCustomerExist(contactNo) {

            fetch('/RestaurantDetail/CustomerExsistOrNo', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    ContactNo: contactNo
                })
            })
            .then(res => res.json())
            .then(data => {

                if (data.statusId === 1) {
                    // ✅ Customer Exist — Fill Fields
                    fillCustomerFields(data);
                }
                else {
                    // ❌ New Customer — Clear Fields
                    clearCheckoutModalFields(false);
                }

            })
            .catch(err => {
                console.error('Error:', err);
            });
        }
        function fillCustomerFields(data) {

            document.getElementById("CustomerName").value = data.customerName || "";
            document.getElementById("CustomerAddress").value = data.customerAddress || "";
            document.getElementById("Street").value = data.street || "";
            document.getElementById("Floor").value = data.floor || "";
            document.getElementById("Description").value = data.description || "";

            // Optional UX feedback
            // alert(data.Message);
        }

        
        function toggleCart() {
            const cartDrawer = document.getElementById('cartDrawer');
            const cartBackdrop = document.getElementById('cartBackdrop');

            cartDrawer.classList.toggle('open');
            cartBackdrop.classList.toggle('show');
        }

        function updateCartCount() {
            let count = 0;
            Object.values(cart).forEach(x => count += x.Quantity);
            document.getElementById('cartCount').textContent = count;
        }

        // MODIFY renderCart()
        const originalRenderCart = renderCart;
        renderCart = function () {
            originalRenderCart();
            updateCartCount();
        }



        document.addEventListener("DOMContentLoaded", function () {
            const inputs = document.querySelectorAll(".next-input");

            inputs.forEach((input, index) => {
                input.addEventListener("keydown", function (e) {
                    if (e.key === "Enter") {
                        e.preventDefault();
                        const next = inputs[index + 1];
                        if (next) {
                            next.focus();
                        } else {
                            placeOrder(); // last field par Enter
                        }
                    }
                });
            });
        });

    </script>


</body>
</html>